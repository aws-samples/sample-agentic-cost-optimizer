stages:
  - test

python-tests:
  stage: test
  image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
  rules:
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run on branch pushes, but not if it's also a merge request
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS == null
  script:
    - uv sync --group agents --group dev
    - uv run pytest tests/ -v --junitxml=test-results.xml
  artifacts:
    reports:
      junit: test-results.xml
    when: always
  cache:
    key:
      files:
        - uv.lock
        - pyproject.toml
    paths:
      - .venv/
