stages:
  - test
  - deploy

variables: {}

test:
  stage: test
  image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
  cache:
    key: python-deps
    paths:
      - .venv/
  before_script:
    - apt-get update && apt-get install -y git make nodejs npm
  script:
    - make init
    - make check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

deploy:
  stage: deploy
  tags:
    - size:large
  image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
  services:
    - name: docker:27-dind
      alias: docker
  variables:
    AWS_DEFAULT_REGION: us-east-1
    CDK_DEFAULT_REGION: us-east-1
    CDK_DEFAULT_ACCOUNT: "249634239082"
    AWS_CREDS_TARGET_ROLE: "arn:aws:iam::249634239082:role/GitLabCI-AgenticCostOptimizer"
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  cache:
    - key: python-deps
      paths:
        - .venv/
    - key: node-deps
      paths:
        - infra/node_modules/
  before_script:
    - apt-get update && apt-get install -y git make nodejs npm docker.io
    - npm install -g aws-cdk
    - until docker info; do echo "Waiting for Docker daemon..."; sleep 2; done
    - docker version
  script:
    - make init
    - make cdk-deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - "src/**/*"
        - "infra/**/*"
        - "requirements/**/*"
        - "pyproject.toml"
        - "uv.lock"
        - "Dockerfile"
